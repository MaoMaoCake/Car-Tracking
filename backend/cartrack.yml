AWSTemplateFormatVersion: 2010-09-09
Description: |
  Cartrack CloudFormation template

Resources:
  CarTrackEC2:
    Type: AWS::EC2::Instance
    Properties:
      # change to singapore
      AvailabilityZone: us-east-1a
      ImageId: ami-01cc34ab2709337aa
      InstanceType: t2.micro
      UserData:
        !Base64 |
        #!/bin/bash
        apt update && apt upgrade -y
        apt install git
        git clone https://github.com/maomaocake/cartrack.git
        cd backend
        python3 -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        export PYTHONPATH=~/Car-Tracking
        python3 app.py
        deactivate
        cd ../cartrack
        npm install
        npm run build
        cd ../cartrack/dist
        serve -s build -l 80
      Tags:
        - Key: Name
          Value: CarTrack
        - Key: Environment
          Value: Dev
        - Key: cie21
          Value: group1

  CarTrackDynamoDBUserTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: username
          AttributeType: S
      KeySchema:
        - AttributeName: username
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      TableName: CarTrackUsers

  CarTrackDynamoDBDeviceTable:
      Type: AWS::DynamoDB::Table
      Properties:
        AttributeDefinitions:
          - AttributeName: device_id
            AttributeType: S
        KeySchema:
          - AttributeName: device_id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: CarTrackDevices

  CarTrackDynamoDBLocationTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: device_id
          AttributeType: S
      KeySchema:
        - AttributeName: device_id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 1
        WriteCapacityUnits: 1
      TableName: CarTrackLocations